# 统一登录管理系统开发计划

## 1. 需求分析与技术栈确定

### 1.1 需求分析
根据PRD文档，我们需要构建一套安全、可扩展、合规的统一登录管理系统，支持多端登录、微信授权、OAuth 2.0协议，并符合相关法律法规要求。

### 1.2 技术栈确定

#### 1.2.1 现有技术栈
- **后端框架**: FastAPI 0.104.1
- **数据库**: SQLAlchemy 2.0.23 + MySQL
- **认证相关**: python-jose 3.3.0, passlib 1.7.4
- **配置管理**: pydantic-settings 2.1.0, python-dotenv 1.0.0
- **其他**: Pydantic 2.5.0, Uvicorn 0.24.0.post1

#### 1.2.2 新增技术栈
- **OAuth 2.0框架**: Authlib 1.3.0
- **短信服务**: 待定（需与客户确认具体服务商）
- **微信SDK**: 微信开放平台SDK
- **缓存**: Redis（用于Token黑名单、验证码存储、限流）
- **日志存储**: Elasticsearch（可选，用于长期日志存储）

## 2. 系统架构与模块划分

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          统一登录管理系统                                │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────────┤
│  账号管理模块 │  认证模块    │  授权模块    │  Token管理模块 │  日志与风控模块   │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────────┤
│  - 注册      │  - 密码登录   │  - OAuth 2.0  │  - Token生成   │  - 操作日志      │
│  - 登录      │  - 验证码登录  │    授权服务器  │  - Token校验   │  - 风控规则      │
│  - 登出      │  - 微信登录    │  - Scope管理  │  - Token失效   │  - 告警通知      │
│  - 信息管理   │  - 扫码登录    │  - 应用管理    │  - 黑名单管理  │  - 数据统计      │
│  - 多账号关联 │  - 设备管理    │              │                │                 │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────────┘
        │              │              │              │              │
        └──────────────┼──────────────┼──────────────┼──────────────┘
                       ▼              ▼              ▼
            ┌─────────────────────────────────────────┐
            │                 数据库层                  │
            ├─────────────┬─────────────┬─────────────┤
            │  用户表      │  应用表      │  日志表      │
            ├─────────────┼─────────────┼─────────────┤
            │  用户凭证表   │  Token表     │  风控规则表   │
            └─────────────┴─────────────┴─────────────┘
                       │              │              │
                       ▼              ▼              ▼
            ┌─────────────────────────────────────────┐
            │                 第三方服务                │
            ├─────────────┬─────────────┬─────────────┤
            │  短信服务     │  微信开放平台  │  Redis缓存    │
            └─────────────┴─────────────┴─────────────┘
```

### 2.2 模块划分

#### 2.2.1 账号管理模块
- **功能**: 处理用户注册、登录、登出、信息管理、多账号关联等基础操作
- **文件结构**:
  - `passport/api/account.py`: 账号相关API接口
  - `passport/services/account_service.py`: 账号业务逻辑
  - `passport/utils/sms_utils.py`: 短信发送与验证
  - `passport/utils/wechat_utils.py`: 微信接口封装

#### 2.2.2 认证模块
- **功能**: 处理各种认证方式，包括密码、验证码、微信登录等
- **文件结构**:
  - `passport/api/auth.py`: 认证相关API接口
  - `passport/services/auth_service.py`: 认证业务逻辑
  - `passport/utils/auth_utils.py`: 认证工具函数
  - `passport/utils/verification_code.py`: 验证码生成与验证

#### 2.2.3 授权模块
- **功能**: 实现OAuth 2.0授权服务器，支持第三方应用接入
- **文件结构**:
  - `passport/api/oauth.py`: OAuth 2.0相关API接口
  - `passport/services/oauth_service.py`: OAuth 2.0业务逻辑
  - `passport/utils/oauth_utils.py`: OAuth 2.0工具函数
  - `passport/models/oauth.py`: OAuth 2.0相关数据模型

#### 2.2.4 Token管理模块
- **功能**: 处理Token的生成、校验、失效等生命周期管理
- **文件结构**:
  - `passport/services/token_service.py`: Token业务逻辑
  - `passport/utils/token_utils.py`: Token工具函数
  - `passport/models/token.py`: Token相关数据模型

#### 2.2.5 日志与风控模块
- **功能**: 记录操作日志、实现风控规则、提供数据统计
- **文件结构**:
  - `passport/api/admin/log.py`: 日志相关API接口
  - `passport/api/admin/risk.py`: 风控相关API接口
  - `passport/services/log_service.py`: 日志业务逻辑
  - `passport/services/risk_service.py`: 风控业务逻辑
  - `passport/models/log.py`: 日志相关数据模型
  - `passport/models/risk.py`: 风控相关数据模型

#### 2.2.6 管理后台模块
- **功能**: 提供账号管理、应用配置、风控告警、日志导出等功能
- **文件结构**:
  - `passport/api/admin/account.py`: 账号管理API接口
  - `passport/api/admin/app.py`: 应用管理API接口
  - `passport/services/admin_service.py`: 管理后台业务逻辑

## 3. 数据库设计

### 3.1 核心数据模型

#### 3.1.1 用户表 (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(11) UNIQUE,
    nickname VARCHAR(50),
    avatar VARCHAR(255),
    gender INT DEFAULT 0, -- 0: 未知, 1: 男, 2: 女
    hashed_password VARCHAR(255),
    status INT DEFAULT 1, -- 1: 启用, 0: 禁用, -1: 注销
    last_login_at DATETIME,
    last_login_ip VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3.1.2 用户凭证表 (user_credentials)
```sql
CREATE TABLE user_credentials (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    credential_type VARCHAR(20) NOT NULL, -- phone, wechat, email
    credential_value VARCHAR(100) NOT NULL,
    credential_info TEXT, -- 额外信息，如微信openid/unionid
    is_primary BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 3.1.3 应用表 (oauth_applications)
```sql
CREATE TABLE oauth_applications (
    id INT PRIMARY KEY AUTO_INCREMENT,
    client_id VARCHAR(100) UNIQUE NOT NULL,
    client_secret VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    icon VARCHAR(255),
    redirect_uris TEXT NOT NULL, -- JSON格式存储多个redirect_uri
    scopes TEXT NOT NULL, -- 允许的scope列表，逗号分隔
    status INT DEFAULT 0, -- 0: 待审核, 1: 已通过, 2: 已禁用
    user_id INT NOT NULL, -- 创建者ID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

## 4. 开发阶段与具体任务

### 4.1 阶段一：基础架构搭建（1周）

#### 4.1.1 任务列表
1. 安装Authlib和Redis依赖
2. 配置Redis连接
3. 创建统一登录管理系统的基础目录结构
4. 实现配置管理（包括短信服务、微信SDK、OAuth 2.0等配置）
5. 设计并实现统一的响应格式和错误处理

### 4.2 阶段二：基础账号体系开发（2周）

#### 4.2.1 任务列表
1. 扩展用户模型，添加手机号、昵称、头像、性别等字段
2. 实现手机号注册功能（支持免密/密码模式）
3. 实现手机号验证码发送与验证功能
4. 实现微信授权注册功能
5. 实现账号信息管理功能
6. 实现多账号关联功能

## 5. 部署与上线计划

### 5.1 部署环境
- **开发环境**: 本地开发环境
- **测试环境**: 云服务器
- **生产环境**: 云服务器集群

### 5.2 部署架构
- **应用服务器**: Uvicorn + Gunicorn
- **数据库**: MySQL
- **缓存**: Redis集群
- **负载均衡**: Nginx
- **日志存储**: ELK Stack（可选）

## 6. 总结

本开发计划详细描述了统一登录管理系统的开发流程，包括需求分析、技术栈确定、系统架构设计、数据库设计、开发阶段划分、测试计划、部署计划和风险评估。通过本计划的实施，我们将构建一套安全、可扩展、合规的统一登录管理系统，满足公司多端产品的用户体系需求。